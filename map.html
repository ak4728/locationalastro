<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Astrology Map | LocationalAstro</title>
    <meta name="description" content="View your personalized astrology map with planetary lines showing cosmic influences worldwide.">
    <meta name="keywords" content="astrocartography, location astrology, birth chart, planetary lines, astrology map">
    <meta name="author" content="LocationalAstro">
    <meta name="robots" content="noindex, nofollow">\n    \n    <!-- Open Graph / Facebook Meta Tags -->\n    <meta property="og:type" content="website">\n    <meta property="og:title" content="Your Astrology Map | LocationalAstro">\n    <meta property="og:description" content="View your personalized astrology map with planetary lines showing cosmic influences worldwide.">\n    <meta property="og:image" content="https://locationalastro.com/images/logo-large.png">\n    <meta property="og:url" content="https://locationalastro.com/map.html">\n    <meta property="og:site_name" content="LocationalAstro">\n    <meta property="og:locale" content="en_US">\n    \n    <!-- Twitter Card Meta Tags -->\n    <meta name="twitter:card" content="summary_large_image">\n    <meta name="twitter:title" content="Your Astrology Map | LocationalAstro">\n    <meta name="twitter:description" content="View your personalized astrology map with planetary lines.">\n    <meta name="twitter:image" content="https://locationalastro.com/images/logo-large.png">\n    <meta name="twitter:site" content="@locationalastro">"
    
    <!-- Favicon and Logo Meta Tags -->
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <meta name="msapplication-TileColor" content="#6366f1">
    <meta name="theme-color" content="#0a0a1a">
    
    <!-- Fonts and Stylesheets -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="styles.css" />
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-652WT4X6XV"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-652WT4X6XV');
    </script>
</head>
<body class="map-page">
    <!-- Navigation Header -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="images/logo-small.png" alt="LocationalAstro" class="logo-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline'">
                <span class="logo-fallback" style="display:none">‚ú®</span>
                <span class="brand-text">LocationalAstro</span>
            </div>
            <div class="nav-links">
                <div class="birth-data-inline">
                    <div class="data-grid" id="dataGrid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
                <a href="index.html" class="nav-link">üè† Home</a>
                <button id="newMapBtn" class="nav-link-button">üÜï New Map</button>
            </div>
        </div>
    </nav>

    <!-- Map Display Section -->
    <section class="map-display-section">
        <div class="container-full">
            <div class="map-stage" id="map-stage">
                <div id="map" class="astro-map"></div>

                <!-- Sliding Legend Panel -->
                <div class="legend-slider" id="legendSlider">
                    <div class="legend-toggle" id="legendToggle">
                        <span class="arrow-icon">‚ñ∫</span>
                    </div>
                    <div class="legend-panel" id="legendPanel">
                        <h3>Planetary Lines</h3>
                        <div class="legend-grid">
                            <div class="line-type"><strong>AC</strong><span>Rising line</span></div>
                            <div class="line-type"><strong>DC</strong><span>Setting line</span></div>
                            <div class="line-type"><strong>MC</strong><span>Overhead line</span></div>
                            <div class="line-type"><strong>IC</strong><span>Underfoot line</span></div>
                        </div>
                        <div class="planet-list" id="planetList"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Hidden form for data persistence -->
    <div style="display: none;">
        <input type="date" id="birthDate">
        <input type="time" id="birthTime">
        <input type="text" id="birthLocation">
        <input type="number" id="birthLat">
        <input type="number" id="birthLon">
        <input type="text" id="tzDisplay">
        <input type="hidden" id="tzOffset">
        <select id="coordinateSystem">
            <option value="mundo">Mundo (Local Space)</option>
            <option value="zodio">Zodio (Alternative)</option>
        </select>
    </div>

    <!-- Scripts -->
    <!-- Emergency brake - MUST run before script.js -->
    <script>
        console.log('=== MAP.HTML EMERGENCY BRAKE ACTIVATED ===');
        // Use more robust path detection for local files
        var isMapPage = window.location.href.includes('map.html') || window.location.pathname.includes('map.html');
        console.log('Is map page:', isMapPage);
        console.log('Current URL:', window.location.href);
        
        if (isMapPage) {
            console.log('Setting map page flags...');
            window.mapPageInitialized = true;
            window.isGeneratingMap = true;
            
            // Safety timeout to reset generating flag
            setTimeout(function() {
                console.log('Resetting isGeneratingMap flag after safety timeout');
                window.isGeneratingMap = false;
            }, 3000);
        }
    </script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>
    <script src="script.js"></script>
    
    <script>
        // Initialize map page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== MAP.HTML DOMContentLoaded ===');
            initializeMapPage();
        });
        
        function initializeMapPage() {
            // Load data from URL parameters or localStorage
            loadMapData();
            
            // Setup navigation
            document.getElementById('newMapBtn')?.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // Initialize legend toggle
            setTimeout(function() {
                const btn = document.getElementById('legendToggle');
                const slider = document.getElementById('legendSlider');
                const panel = document.getElementById('legendPanel');
                
                if (btn && slider && panel) {
                    console.log('Setting up legend slider toggle');
                    
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Toggle the slider, not the panel
                        const isOpen = slider.classList.toggle('open');
                        panel.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
                        
                        console.log('Legend slider toggled:', isOpen);
                    });
                } else {
                    console.warn('Legend elements not found:', {
                        btn: !!btn,
                        slider: !!slider,
                        panel: !!panel
                    });
                }
            }, 500);
            
            // Force populate legend content for debugging
            setTimeout(function() {
                const planetList = document.getElementById('planetList');
                if (planetList && planetList.children.length === 0) {
                    console.log('Populating legend manually...');
                    
                    const planets = [
                        { name: 'Sun', color: '#FFD700', symbol: '‚òâ' },
                        { name: 'Moon', color: '#C0C0C0', symbol: '‚òΩ' },
                        { name: 'Mercury', color: '#87CEEB', symbol: '‚òø' },
                        { name: 'Venus', color: '#FF69B4', symbol: '‚ôÄ' },
                        { name: 'Mars', color: '#FF4500', symbol: '‚ôÇ' },
                        { name: 'Jupiter', color: '#FFA500', symbol: '‚ôÉ' },
                        { name: 'Saturn', color: '#8B4513', symbol: '‚ôÑ' },
                        { name: 'Uranus', color: '#40E0D0', symbol: '‚ôÖ' },
                        { name: 'Neptune', color: '#4169E1', symbol: '‚ôÜ' },
                        { name: 'Pluto', color: '#8A2BE2', symbol: '‚ôá' }
                    ];
                    
                    planets.forEach(function(planet) {
                        const item = document.createElement('div');
                        item.className = 'planet-item';
                        item.innerHTML = `
                            <span class="planet-symbol" style="color: ${planet.color}">${planet.symbol}</span>
                            <span class="planet-name">${planet.name}</span>
                        `;
                        planetList.appendChild(item);
                    });
                    
                    console.log('Legend populated with', planets.length, 'planets');
                }
            }, 1500);
        }
        
        function loadMapData() {
            const params = new URLSearchParams(window.location.search);
            
            // Load from URL parameters
            if (params.has('date')) {
                document.getElementById('birthDate').value = params.get('date');
                document.getElementById('birthTime').value = params.get('time');
                document.getElementById('birthLocation').value = decodeURIComponent(params.get('location'));
                document.getElementById('birthLat').value = params.get('lat');
                document.getElementById('birthLon').value = params.get('lon');
                document.getElementById('tzOffset').value = params.get('tz');
                document.getElementById('coordinateSystem').value = params.get('system') || 'mundo';
                
                // Update data summary
                updateDataSummary();
                
                // Render the map with astrology lines
                renderMap();
            }
        }
        
        function renderMap() {
            console.log('=== RENDERING MAP ON MAP.HTML ===');
            
            // Get birth data from hidden form elements
            const birthLat = parseFloat(document.getElementById('birthLat').value);
            const birthLon = parseFloat(document.getElementById('birthLon').value);
            const coordinateSystem = document.getElementById('coordinateSystem').value;
            
            console.log('Birth coordinates:', birthLat, birthLon);
            console.log('Coordinate system:', coordinateSystem);
            
            // DON'T create map - it's already created by script.js
            // Just verify it exists
            if (!window.map) {
                console.error('Map not initialized by script.js!');
                return;
            }
            
            console.log('Map exists, centering on birth location...');
            
            // Center map on birth location
            window.map.setView([birthLat, birthLon], 2);
            
            // Add birth location marker
            const birthMarker = L.marker([birthLat, birthLon]).addTo(window.map);
            const location = document.getElementById('birthLocation').value;
            birthMarker.bindPopup(`<strong>Birth Location</strong><br>${location}`);
            
            // Wait for map to be fully ready before generating lines
            console.log('Waiting for map to be ready...');
            setTimeout(function() {
                console.log('Calling generateAstrologyMap...');
                if (window.generateAstrologyMap) {
                    try {
                        window.generateAstrologyMap();
                        console.log('Astrology lines generated successfully');
                        
                        // Force map to refresh/render
                        setTimeout(function() {
                            if (window.map) {
                                window.map.invalidateSize();
                                console.log('Map size invalidated to force refresh');
                            }
                        }, 100);
                        
                    } catch (error) {
                        console.error('Error generating astrology lines:', error);
                    }
                } else {
                    console.error('generateAstrologyMap function not available');
                }
            }, 1000); // Wait 1 second for map to be fully ready
        }
        
        function updateDataSummary() {
            const dataGrid = document.getElementById('dataGrid');
            const data = {
                'Date': document.getElementById('birthDate').value,
                'Time': document.getElementById('birthTime').value,
                'Location': document.getElementById('birthLocation').value,
                'Coordinates': `${document.getElementById('birthLat').value}, ${document.getElementById('birthLon').value}`,
                'System': document.getElementById('coordinateSystem').value
            };
            
            dataGrid.innerHTML = '';
            for (const [key, value] of Object.entries(data)) {
                const item = document.createElement('div');
                item.className = 'data-item';
                item.innerHTML = `<strong>${key}:</strong> ${value}`;
                dataGrid.appendChild(item);
            }
        }
    </script>
</body>
</html>